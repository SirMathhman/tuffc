extern let { malloc, realloc, free } = stdlib;
extern let { strlen, strcpy, strcat } = string;

type StringBuilder = I32;

extern fn malloc(size : USize) : I32;
extern fn realloc(ptr : I32, size : USize) : I32;
extern fn free(ptr : I32) : Void;
extern fn strlen(s : *Str) : USize;
extern fn strcpy(dst : I32, src : *Str) : I32;
extern fn strcat(dst : I32, src : *Str) : I32;

out expect fn sb_new() : StringBuilder;
out expect fn sb_append(this : StringBuilder, s : *Str) : StringBuilder;
out expect fn sb_append_char(this : StringBuilder, code : I32) : StringBuilder;
out expect fn sb_build(this : StringBuilder) : *Str;

out actual fn sb_new() : StringBuilder => {
	let ptr = malloc(1USize);
	if (ptr == 0) return 0;
	strcpy(ptr, "");
	ptr
};

out actual fn sb_append(this : StringBuilder, s : *Str) : StringBuilder => {
	if (this == 0) return this;
	let need = strlen(this) + strlen(s) + 1USize;
	let grown = realloc(this, need);
	if (grown == 0) return this;
	strcat(grown, s);
	grown
};

out actual fn sb_append_char(this : StringBuilder, code : I32) : StringBuilder => {
	// TODO: replace placeholder with proper codepoint encoding helper.
	sb_append(this, "?")
};

out actual fn sb_build(this : StringBuilder) : *Str => this;
